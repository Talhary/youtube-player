const cookies = [
    {
        "domain": ".youtube.com",
        "expirationDate": 1743928479.86328,
        "hostOnly": false,
        "httpOnly": true,
        "name": "VISITOR_PRIVACY_METADATA",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "CgJQSxIEGgAgSg%3D%3D"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1733414518,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_gcl_au",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "1.1.1105463588.1725638518"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1762402122.12545,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-YEC",
        "path": "/",
        "sameSite": "lax",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "CgtaeU1PcS1kbVVIcyjjvY24BjIKCgJHQhIEGgAgaA%3D%3D"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.775354,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "g.a000pgifhp4Q12hi0LG03dbhKW7DS8Bskk9ZMJsdfmDmYTom45NRE3jKcAuiHScuG8Xsf3sxjgACgYKAc8SARUSFQHGX2Mi_zPNAnEF6aKA6_mR4zu79hoVAUF8yKp_NJT7rMSqNibR49S4tdHq0076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761817851.101141,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SIDCC",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "AKEyXzWfm7lb18rq8fbTLwFTH9sNYNJwP3HmsCw75BmMVwY8CMq5zFTgT_Uf-Qsp3MwJoIcuHA"
    },
    {
        "domain": ".youtube.com",
        "hostOnly": false,
        "httpOnly": true,
        "name": "YSC",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": null,
        "value": "tf9qQBkAe88"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.775252,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "g.a000pgifhp4Q12hi0LG03dbhKW7DS8Bskk9ZMJsdfmDmYTom45NRt-cwUWUX3mkbGKIhTPFKhgACgYKAV8SARUSFQHGX2MiA3IqbDnfH0rIzRC9ltGobRoVAUF8yKoeBiqUJD0jANuPGazsRC1o0076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761648188.811568,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSIDTS",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "sidts-CjEBQT4rX-QX3SOp4iMjZXcNhatzVykRg3mstnl5m6qEjKpIeJS_KgV1dTOVL8ygsBrDEAA"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1730282199,
        "hostOnly": false,
        "httpOnly": false,
        "name": "CONSISTENCY",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AKreu9sZn_z9lGfhL5_BOAsvfmlizGyK-YncfQy6un75MUOmoHtwSVxhlHSrdnks5W7Cb3NfhK71tF7RPA5AVBGwbeBfgh5ajKNJapSNsnLuKoEYUkGPWtg_0PsJqao0uXS4HcwIEJo-T1tuSdgQuSaucXDbODCwMI4xssxu8tkfFBNzezPksdi5"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.774941,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SAPISID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "QI6O5OLsaEnsUY3K/AfUpzSjW4SUhbn4l9"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761817851.101354,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSIDCC",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AKEyXzWcMqt4BGfxYR6q92BCyUSz95ILb7E5JIFdEIq7FINceMfPTGm6FfYfJ1wjn8-COX5Sd3c"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.774827,
        "hostOnly": false,
        "httpOnly": true,
        "name": "SSID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AZxPS1PRwpKYyhmlj"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.774994,
        "hostOnly": false,
        "httpOnly": false,
        "name": "__Secure-1PAPISID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "QI6O5OLsaEnsUY3K/AfUpzSjW4SUhbn4l9"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.775301,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "g.a000pgifhp4Q12hi0LG03dbhKW7DS8Bskk9ZMJsdfmDmYTom45NRNHrec0JVhCGNd2SQmRRxSAACgYKAfUSARUSFQHGX2Mi4pnugFiLZZ5WXFVmKme5gBoVAUF8yKrhcCLUMcAOTCoKK7l3Oj3p0076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.775046,
        "hostOnly": false,
        "httpOnly": false,
        "name": "__Secure-3PAPISID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "QI6O5OLsaEnsUY3K/AfUpzSjW4SUhbn4l9"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761817851.101472,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSIDCC",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AKEyXzUAkMP1UOz0UonXkQ_UAbF_KH4Va8zL5W0_BOsIqFWddFAGeiyGyucJFaHPju7FF3q0HEA"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1761648188.811776,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSIDTS",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "sidts-CjEBQT4rX-QX3SOp4iMjZXcNhatzVykRg3mstnl5m6qEjKpIeJS_KgV1dTOVL8ygsBrDEAA"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1760969484.582328,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_ga",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "GA1.1.911662981.1726409147"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1760969502.791636,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_ga_VCGEPY40VB",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "GS1.1.1726409146.1.1.1726409502.40.0.0"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.774885,
        "hostOnly": false,
        "httpOnly": false,
        "name": "APISID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "iXZ2yVsqVt5R0uju/AMGx0grtk5XdhXtFW"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764774056.774709,
        "hostOnly": false,
        "httpOnly": true,
        "name": "HSID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "AbQRY9cHopLQNeTX9"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764335597.957433,
        "hostOnly": false,
        "httpOnly": true,
        "name": "LOGIN_INFO",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AFmmF2swRgIhAPXEN9u2BHveiFaM1Xo-7Hoi3xT3i7s8KqfRIzOfx1NZAiEAj99M9f_PeI9c6PoTyKH0Dmmq_eX4J3UZEbV26bkG4Bs:QUQ3MjNmeER3QlRyRG9ZRGJaZXY1dDBmakppeEFFMTJlQ3hVVlBMRXp1d2lvT1h4TktaanpLdlZUa1ExRlIwY1AxbDV3Zjg5SElNSDRJSHhTaExJLTdERlNacUxjczhIVHB2TnhIV2xzbDV1VVZ3R1NxMXM4UjhWMFVuY0tVQjhUVmN0QVZ1Mk96WmlRWWQ1eEt3MjZVX0dnYjA3bG40cjZn"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1742220350.498699,
        "hostOnly": false,
        "httpOnly": true,
        "name": "NID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "517=Fh_gRvLRWb6u9vNJXcPUJkoi2w4gN4noeXRr_fHeE7dLeCHMnU7ZSHgfAXwnsJyPAXv93fiL6t3raFhkdl5_kApni4n_MWu5NL_JYc8JS7-v8p40d1HycNFk3UwWW94s5A-g6MWDjdBA-aKqeZBTilwbtWr0g0QDO7agFnw2dlx-X-JDGChO_ei-m61Aji8BtFYHY5HKsU8sc0rdQYA9N2O2JKKUFl5CbcmteStsRnfTj8baPw"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1764841683.744614,
        "hostOnly": false,
        "httpOnly": false,
        "name": "PREF",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "volume=62&f6=80&f7=100&tz=Asia.Karachi&repeat=NONE&autoplay=true"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1743928479.863218,
        "hostOnly": false,
        "httpOnly": true,
        "name": "VISITOR_INFO1_LIVE",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "FhBbJkSDphg"
    }
]
const ytdl = require('@distube/ytdl-core');
const agent = ytdl.createAgent(cookies);
const fs = require('fs');
const path = require('path');

const getYtInfo = async (req, res) => {
    let { url, quality } = req.query;
   
    if (!url) {
        res.status(400).json({ status: 400, message: 'we need url mf' });
        return;
    }
    
    try {
        let infoYt = await ytdl.getInfo(url, { agent });
        let titleYt = infoYt.videoDetails.title.replace(/[^a-zA-Z0-9]/g, '');
        if (!quality) quality = '360';
        fs.writeFileSync('data.json',JSON.stringify(infoYt.formats))
        const format = infoYt.formats.filter(el => el.height >= quality  && el.audioBitrate ).slice(-1)[0];
        
        if (!format) {
            console.log('âŒ No matching quality found!');
            res.json({ msg: 'No matching quality Found' }).status(400);
            return;
        }

        const downloadsDir = path.resolve(__dirname, 'downloads');
        if (!fs.existsSync(downloadsDir)) {
            fs.mkdirSync(downloadsDir);
        }

        const file = path.resolve(downloadsDir, `${titleYt}.mp4`);

        const stream = ytdl(url, { agent, format }).pipe(fs.createWriteStream(file));

        await new Promise((resolve, reject) => {
            stream.on("error", reject);
            stream.on("finish", resolve);
        });
        
        res.sendFile(file);

        setTimeout(() => {
            if (fs.existsSync(file)) fs.unlinkSync(file);
        }, 1 * 60 * 60_000);
    } catch (error) {
        console.error('Error:', error);
        res.status(500).json({ status: 500, message: 'An error occurred', error: error.message || error.msg });
    }
};

module.exports = { getYtInfo };