const cookies = [
    {
        "domain": ".youtube.com",
        "expirationDate": 1750673167.61988,
        "hostOnly": false,
        "httpOnly": true,
        "name": "VISITOR_PRIVACY_METADATA",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "CgJQSxIEGgAgNQ%3D%3D"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1741517574,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_gcl_au",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "1.1.45671700.1733741574"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1762402122.12545,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-YEC",
        "path": "/",
        "sameSite": "lax",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "CgtaeU1PcS1kbVVIcyjjvY24BjIKCgJHQhIEGgAgaA%3D%3D"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.207801,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "g.a000rgifhrW2M50Z2mpQf3ns5LhjIdVQuzFQrI8pGV_-wMzuMSAYXYvjaW4_XIGvg7fkYgAvIwACgYKAbgSARUSFQHGX2MiU8AeCJk_hVMSMR1dYqt3VxoVAUF8yKpBWu4KYp0sMAKMO4S-jACQ0076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1766766532.917088,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SIDCC",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "AKEyXzWHyB0xgKq7q26-ujfcJiMQ4jsLJxAiBqV4hDl3cG2qduDN5_qKJH4KukUba0sMr4EMUQ"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.207574,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "g.a000rgifhrW2M50Z2mpQf3ns5LhjIdVQuzFQrI8pGV_-wMzuMSAYzwaeZP9yZbV6Wu1gssd8agACgYKAaISARUSFQHGX2MiR8ln4QQEw70TK8vqDBVtyxoVAUF8yKonB1qhKNmcRHGwWnVF9CL30076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1766763663.860691,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSIDTS",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "sidts-CjIB7wV3saxQ5M9TpAtlKUUNNK205XmWZozK8suHUtQGppA6mlYs6a2BIcgRKdATr_7LyhAA"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.206556,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SAPISID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "QG72f_cbY5glN9w5/AtdzgCpLQPjMRTRDO"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1766766532.917216,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSIDCC",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AKEyXzW8g8TZnzQun1MjaDZyRmWbA1_i9Y7rctjiOYHEUPNmWrp5FWK73yWLmtnuF9f8aCAWcUc"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.20633,
        "hostOnly": false,
        "httpOnly": true,
        "name": "SSID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AOtxeoaQ564dLwW21"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.206673,
        "hostOnly": false,
        "httpOnly": false,
        "name": "__Secure-1PAPISID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "QG72f_cbY5glN9w5/AtdzgCpLQPjMRTRDO"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.207687,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-1PSID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "g.a000rgifhrW2M50Z2mpQf3ns5LhjIdVQuzFQrI8pGV_-wMzuMSAYC98UQMUaNQu8cnAU0i64pwACgYKAakSARUSFQHGX2MiJcuBHEC3yV1x266Dg__3zBoVAUF8yKoGxDx1VW_v-KXewYcOVVPY0076"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.206783,
        "hostOnly": false,
        "httpOnly": false,
        "name": "__Secure-3PAPISID",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "QG72f_cbY5glN9w5/AtdzgCpLQPjMRTRDO"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1766766532.91733,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSIDCC",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AKEyXzVON6XruSe0Xa6HzkQZ-DVGY8tq7twMh_FqFVFmwCGLvAfT1Hm7jshDPXXt4BnqfNy6_mI"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1766763663.860908,
        "hostOnly": false,
        "httpOnly": true,
        "name": "__Secure-3PSIDTS",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "sidts-CjIB7wV3saxQ5M9TpAtlKUUNNK205XmWZozK8suHUtQGppA6mlYs6a2BIcgRKdATr_7LyhAA"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1760969484.582328,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_ga",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "GA1.1.911662981.1726409147"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1760969502.791636,
        "hostOnly": false,
        "httpOnly": false,
        "name": "_ga_VCGEPY40VB",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "GS1.1.1726409146.1.1.1726409502.40.0.0"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.206441,
        "hostOnly": false,
        "httpOnly": false,
        "name": "APISID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "u8C9dxjxtoZVbZWG/AKq-POWOMg1f69hJA"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769770662.206216,
        "hostOnly": false,
        "httpOnly": true,
        "name": "HSID",
        "path": "/",
        "sameSite": null,
        "secure": false,
        "session": false,
        "storeId": null,
        "value": "A3X2W2Kc8Ua3ggLL-"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769445515.155651,
        "hostOnly": false,
        "httpOnly": true,
        "name": "LOGIN_INFO",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "AFmmF2swRAIgPVlqp_MXF9cJ5Jdl9utp9aEG-ilDvtm2fC6ugEmw2HMCIB5b173p2WZ652b8eeZciCMibCIydzrfWeQVk3WeY6yP:QUQ3MjNmd1JleEwzXzA5ekhHX0VleW84anBVbzdVQk9LRnJHNW9HeHJqNE0wdzBKZ3ZoM1RFaE9iTUNVTl9Bc0JCZEZ1MS0xVGFHdWZSRllNSFZVOTJkVmg1Z1YtY3VWWm53anFUdWlnTFJaZ1lSNHYxc25SNGJMeUIxdWlWN3FGYk9xbVpUV2dqLXRtQTlhWjV3NTczSmlvRUVtSWptZER3"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1742220350.498699,
        "hostOnly": false,
        "httpOnly": true,
        "name": "NID",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "517=Fh_gRvLRWb6u9vNJXcPUJkoi2w4gN4noeXRr_fHeE7dLeCHMnU7ZSHgfAXwnsJyPAXv93fiL6t3raFhkdl5_kApni4n_MWu5NL_JYc8JS7-v8p40d1HycNFk3UwWW94s5A-g6MWDjdBA-aKqeZBTilwbtWr0g0QDO7agFnw2dlx-X-JDGChO_ei-m61Aji8BtFYHY5HKsU8sc0rdQYA9N2O2JKKUFl5CbcmteStsRnfTj8baPw"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1769787789.823435,
        "hostOnly": false,
        "httpOnly": false,
        "name": "PREF",
        "path": "/",
        "sameSite": null,
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "volume=29&f6=40000080&f7=100&tz=Asia.Karachi&repeat=NONE&autoplay=true"
    },
    {
        "domain": ".youtube.com",
        "expirationDate": 1750673167.619637,
        "hostOnly": false,
        "httpOnly": true,
        "name": "VISITOR_INFO1_LIVE",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": null,
        "value": "MY8ddvggamg"
    }
]
const ytdl = require('@distube/ytdl-core');
const agent = ytdl.createAgent(cookies);
const fs = require('fs');
const axios = require('axios')
const path = require('path');
const { combineAudioVideo } = require('./audio-video-mix');
async function downloadFile(url, outputPath) {
    const response = await axios({
        url,
        method: 'GET',
        responseType: 'stream',
    });
    return new Promise((resolve, reject) => {
        const writer = fs.createWriteStream(outputPath);
        response.data.pipe(writer);
        writer.on('finish', () => resolve(outputPath));
        writer.on('error', reject);
    });
}
const getYtInfo = async (req, res) => {
    let { url, quality, type } = req.query;

    if (!url) {
        res.status(400).json({ status: 400, message: 'we need url mf' });
        return;
    }

    try {
        let infoYt = await ytdl.getInfo(url, { agent });
        // fs.writeFileSync('data.json',JSON.stringify(infoYt))
        // console.log(infoYt)
        if (!type) type = 'video';

        if (!quality) quality = '360p';
        let titleYt = infoYt.videoDetails.title.replace(/[^a-zA-Z0-9]/g, match => (match === ' ' ? '_' : '')).split('').slice(0, 30).join('') + '_' + quality + '_' + type;
        if (type === 'audio') {
            const audio = infoYt.formats.filter(el => el.hasAudio && el.hasVideo == false).slice(-1)[0];
            const downloadsDir = path.resolve(__dirname, 'downloads');
            if (!fs.existsSync(downloadsDir)) {
                fs.mkdirSync(downloadsDir);
            }
            const file = path.resolve(downloadsDir, `${titleYt}.mp3`);
            await downloadFile(audio.url, file);
            res.setHeader('Content-Disposition', 'attachment; filename=' + `"${titleYt}.mp3"`);

            res.download(file)
            setTimeout(() => {
                if (fs.existsSync(file)) fs.unlinkSync(file);
            }, 1 * 60 * 60_000);
            return;
        }
        // fs.writeFileSync('data.json',JSON.stringify(infoYt.formats))
        const format = infoYt.formats.filter(el => el.qualityLabel == quality && el.audioBitrate).slice(-1)[0];

        if (!format) {
            const downloadsDir = path.resolve(__dirname, 'downloads');
            if (!fs.existsSync(downloadsDir)) {
                fs.mkdirSync(downloadsDir);
            }
            const video = infoYt.formats.filter(el => el.qualityLabel == quality).slice(-1)[0];
            const audio = infoYt.formats.filter(el => el.hasAudio && el.hasVideo == false).slice(-1)[0];
            if (!video || !audio) {
                res.set('Content-Type', 'text/html');
                res.send(Buffer.from('<h2>Quality not found</h2>'));
                return
            }            // console.log(video,audio);
            // res.json({file:video,audio:audio})
            // return
            const file = path.resolve(downloadsDir, `${titleYt}.mp4`);
            if (fs.existsSync(file)) {
                return res.download(file)
            }
            const pathofVideo = await combineAudioVideo(video["url"], audio["url"], downloadsDir, file)
            setTimeout(() => {
                if (fs.existsSync(file)) fs.unlinkSync(file);
            }, 1 * 60 * 60_000);
            res.setHeader('Content-Disposition', 'attachment; filename=' + `"${titleYt}.mp4"`);

            return res.download(file);

            setTimeout(() => {
                if (fs.existsSync(file)) fs.unlinkSync(file);
            }, 1 * 60 * 60_000);
            console.log(pathofVideo)
            console.log('❌ No matching quality found!');
            res.json({ msg: 'No matching quality Found' }).status(400);
            return;
        }

        const downloadsDir = path.resolve(__dirname, 'downloads');
        if (!fs.existsSync(downloadsDir)) {
            fs.mkdirSync(downloadsDir);
        }

        const file = path.resolve(downloadsDir, `${titleYt}.mp4`);
        if (fs.existsSync(file)) {
            return res.sendFile(file)
        }
        const stream = ytdl(url, { agent, format }).pipe(fs.createWriteStream(file));

        await new Promise((resolve, reject) => {
            stream.on("error", reject);
            stream.on("finish", resolve);
        });
        res.setHeader('Content-Disposition', 'attachment; filename=' + `"${titleYt}.mp4"`);

        res.download(file);

        setTimeout(() => {
            if (fs.existsSync(file)) fs.unlinkSync(file);
        }, 1 * 60 * 60_000);
    } catch (error) {
        console.error('Error:', error);
        res.status(500).json({ status: 500, message: 'An error occurred', error: error.message || error.msg });
    }
};

module.exports = { getYtInfo };
